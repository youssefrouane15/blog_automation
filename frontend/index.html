<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Articles Automation SaaS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }

        .app-container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            margin: 10px;
            overflow: hidden;
            min-height: calc(100vh - 20px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .sidebar {
            background: linear-gradient(180deg, var(--dark) 0%, #334155 100%);
            min-height: 100vh;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 15px 20px;
            border-radius: 8px;
            margin: 5px 15px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            border: none;
            background: none;
            text-decoration: none;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateX(5px);
        }

        .main-content {
            padding: 30px;
            background: white;
            min-height: 100vh;
        }

        .website-card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .website-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .website-card.processing {
            border-left: 4px solid var(--warning);
            animation: pulse 2s infinite;
        }

        .website-card.completed {
            border-left: 4px solid var(--success);
        }

        .website-card.idle {
            border-left: 4px solid #6b7280;
        }

        .website-card.error {
            border-left: 4px solid var(--danger);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .progress-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: conic-gradient(var(--primary) 0deg, #e5e7eb 0deg);
        }

        .progress-circle::before {
            content: '';
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            position: absolute;
        }

        .progress-circle span {
            position: relative;
            z-index: 1;
            font-weight: 600;
            color: var(--primary);
            font-size: 14px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-idle { background: #f3f4f6; color: #6b7280; }
        .status-processing { background: #fef3c7; color: #d97706; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-error { background: #fee2e2; color: #dc2626; }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), #3b82f6);
            color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .stat-card h3 {
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
        }

        .stat-card p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, var(--primary), #3b82f6);
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            color: white;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
            color: white;
        }

        .progress-details {
            background: var(--light);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .step-progress {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .step-progress .icon {
            width: 20px;
            margin-right: 10px;
        }

        .completion-banner {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            text-align: center;
            display: none;
        }

        .completion-banner.show {
            display: block;
        }

        .keyword-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
        }

        .keyword-item:last-child {
            border-bottom: none;
        }

        .mobile-menu {
            display: none;
        }

        @media (max-width: 768px) {
            .app-container {
                margin: 5px;
                border-radius: 8px;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: -100%;
                width: 280px;
                height: 100vh;
                transition: left 0.3s ease;
                z-index: 2000;
            }

            .sidebar.show {
                left: 0;
            }

            .mobile-menu {
                display: block;
                position: fixed;
                top: 15px;
                left: 15px;
                z-index: 1500;
                background: var(--primary);
                color: white;
                border: none;
                border-radius: 8px;
                padding: 10px;
            }

            .main-content {
                padding: 60px 15px 15px 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1900;
        }

        .overlay.show {
            display: block;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // API Configuration - Auto-detects environment
        const getApiBaseUrl = () => {
            if (typeof window !== 'undefined') {
                const hostname = window.location.hostname;
                const protocol = window.location.protocol;
                
                // Production detection
                if (hostname !== 'localhost' && hostname !== '127.0.0.1') {
                    return `${protocol}//${hostname}`;
                }
                
                // Development fallback
                return 'http://localhost:8000';
            }
            return 'http://localhost:8000';
        };

        const API_BASE_URL = getApiBaseUrl();

        // Zustand-like state management
        const createStore = (initialState, actions) => {
            let state = initialState;
            const listeners = new Set();

            const setState = (partial) => {
                const newState = typeof partial === 'function' ? partial(state) : partial;
                state = { ...state, ...newState };
                listeners.forEach(listener => listener(state));
            };

            const getState = () => state;

            const subscribe = (listener) => {
                listeners.add(listener);
                return () => listeners.delete(listener);
            };

            const boundActions = {};
            Object.keys(actions).forEach(key => {
                boundActions[key] = (...args) => actions[key](getState, setState, ...args);
            });

            return { getState, setState, subscribe, ...boundActions };
        };

        // API Service
        class ApiService {
            constructor() {
                this.baseURL = API_BASE_URL;
                this.token = localStorage.getItem('auth_token');
            }

            getHeaders() {
                const headers = { 'Content-Type': 'application/json' };
                
                const token = localStorage.getItem('auth_token');
                if (token && token !== 'null') {
                    headers.Authorization = `Bearer ${token}`;
                    console.log('🔑 Added auth header');
                } else {
                    console.warn('⚠️ No auth token found');
                }
                
                return headers;
            }

            async request(endpoint, options = {}) {
                const url = `${this.baseURL}${endpoint}`;
                const config = {
                    headers: this.getHeaders(),
                    ...options,
                };

                try {
                    const response = await fetch(url, config);
                    
                    if (!response.ok) {
                        if (response.status === 401) {
                            this.logout();
                            throw new Error('Authentication required');
                        }
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('API request failed:', error);
                    throw error;
                }
            }

            async login(username, password) {
                try {
                    const response = await this.request('/api/login', {
                        method: 'POST',
                        body: JSON.stringify({ username, password }),
                    });
                    
                    if (response.access_token) {
                        // Store token with explicit key
                        const token = response.access_token;
                        localStorage.setItem('auth_token', token);
                        
                        // Update instance token immediately
                        this.token = token;
                        
                        // Verify token works immediately
                        const verification = await this.verifyAuth();
                        if (!verification) {
                            throw new Error('Token verification failed after login');
                        }
                        
                        console.log('✅ Login successful and verified');
                        return response;
                    }
                    
                    throw new Error('No access token received');
                    
                } catch (error) {
                    console.error('❌ Login failed:', error);
                    throw error;
                }
            }

            logout() {
                this.token = null;
                localStorage.removeItem('auth_token');
                localStorage.removeItem('user_data');
            }

            async verifyAuth() {
                try {
                    await this.request('/api/verify');
                    return true;
                } catch {
                    return false;
                }
            }

            async getWebsites() {
                return await this.request('/wordpress-sites');
            }

            async startWebsite(name) {
                return await this.request(`/api/website/${name}/start`, {
                    method: 'POST',
                });
            }

            async stopWebsite(name) {
                return await this.request(`/api/website/${name}/stop`, {
                    method: 'POST',
                });
            }

            async getProgress(websiteName = null) {
                const endpoint = websiteName 
                    ? `/api/website/${encodeURIComponent(websiteName)}/progress`
                    : '/api/progress';
                return await this.request(endpoint);
            }

            async startAllWebsites() {
                return await this.request('/start-process', {
                    method: 'POST',
                    body: JSON.stringify({ start: true }),
                });
            }
        }

        const api = new ApiService();

        // Global Store
        const useStore = (() => {
            const store = createStore(
                {
                    isAuthenticated: false,
                    user: null,
                    websites: [],
                    websiteStatuses: {},
                    globalProgress: null,
                    loading: false,
                    error: null,
                    activeTab: 'dashboard',
                    showMobileMenu: false,
                },
                {
                    login: async (get, set, username, password) => {
                        set({ loading: true, error: null });
                        try {
                            const response = await api.login(username, password);
                            set({ 
                                isAuthenticated: true, 
                                user: { username: response.username },
                                loading: false 
                            });
                            return true;
                        } catch (error) {
                            set({ error: error.message, loading: false });
                            return false;
                        }
                    },

                    logout: (get, set) => {
                        api.logout();
                        set({
                            isAuthenticated: false,
                            user: null,
                            websites: [],
                            websiteStatuses: {}
                        });
                    },

                    checkAuth: async (get, set) => {
                        const token = localStorage.getItem('auth_token');
                        if (token) {
                            const isValid = await api.verifyAuth();
                            set({ isAuthenticated: isValid });
                            if (isValid) {
                                const userData = localStorage.getItem('user_data');
                                if (userData) {
                                    set({ user: JSON.parse(userData) });
                                }
                            }
                        }
                    },

                    loadWebsites: async (get, set) => {
                        set({ loading: true });
                        try {
                            const response = await api.getWebsites();
                            set({ websites: response.sites || [], loading: false });
                        } catch (error) {
                            set({ error: error.message, loading: false });
                        }
                    },
                    loadProgress: async (get, set) => {
                        try {
                            const { websites } = get();
                            const statuses = {};
                            
                            // Get the overall progress which includes all website states
                            try {
                                const overallResponse = await api.request('/api/progress');
                                
                                if (overallResponse.data && overallResponse.data.website_stats) {
                                    // Use the website_stats directly from backend
                                    const websiteStats = overallResponse.data.website_stats;
                                    
                                    for (const website of websites) {
                                        const backendStats = websiteStats[website.name];
                                        
                                        if (backendStats) {
                                            statuses[website.name] = {
                                                status: backendStats.status || 'idle',
                                                currentKeyword: backendStats.current_keyword || '',
                                                currentStep: backendStats.current_step || '',
                                                completedKeywords: backendStats.completed || 0,
                                                totalKeywords: backendStats.total_keywords || 0,
                                                progress: backendStats.progress || 0,
                                                keywords: backendStats.keywords || [],
                                                lastUpdate: backendStats.last_update || new Date().toISOString()
                                            };
                                            
                                            console.log(`Updated ${website.name}:`, statuses[website.name]);
                                        } else {
                                            // Website not in stats, set default
                                            statuses[website.name] = {
                                                status: 'idle',
                                                currentKeyword: '',
                                                currentStep: '',
                                                completedKeywords: 0,
                                                totalKeywords: 0,
                                                progress: 0,
                                                keywords: []
                                            };
                                        }
                                    }
                                }
                            } catch (error) {
                                console.error('Failed to load overall progress:', error);
                                
                                // Fallback to individual website progress
                                for (const website of websites) {
                                    try {
                                        const response = await api.getProgress(website.name);
                                        const websiteProgress = response.progress || {};
                                        
                                        statuses[website.name] = {
                                            status: websiteProgress.status || 'idle',
                                            currentKeyword: websiteProgress.current_keyword || '',
                                            currentStep: websiteProgress.current_step || '',
                                            completedKeywords: websiteProgress.completed || 0,
                                            totalKeywords: websiteProgress.total_keywords || 0,
                                            progress: websiteProgress.progress || 0,
                                            keywords: websiteProgress.keywords || []
                                        };
                                    } catch (error) {
                                        console.error(`Failed to load progress for ${website.name}:`, error);
                                        statuses[website.name] = {
                                            status: 'idle',
                                            currentKeyword: '',
                                            currentStep: '',
                                            completedKeywords: 0,
                                            totalKeywords: 0,
                                            progress: 0,
                                            keywords: []
                                        };
                                    }
                                }
                            }
                            
                            set({ websiteStatuses: statuses });
                            
                        } catch (error) {
                            console.error('Failed to load progress:', error);
                        }
                    },

                    startWebsite: async (get, set, websiteName) => {
                        try {
                            await api.startWebsite(websiteName);
                            // Update status immediately
                            const { websiteStatuses } = get();
                            set({
                                websiteStatuses: {
                                    ...websiteStatuses,
                                    [websiteName]: {
                                        ...websiteStatuses[websiteName],
                                        status: 'processing'
                                    }
                                }
                            });
                        } catch (error) {
                            set({ error: error.message });
                        }
                    },

                    stopWebsite: async (get, set, websiteName) => {
                        try {
                            await api.stopWebsite(websiteName);
                            // Update status immediately
                            const { websiteStatuses } = get();
                            set({
                                websiteStatuses: {
                                    ...websiteStatuses,
                                    [websiteName]: {
                                        ...websiteStatuses[websiteName],
                                        status: 'idle'
                                    }
                                }
                            });
                        } catch (error) {
                            set({ error: error.message });
                        }
                    },

                    startAllWebsites: async (get, set) => {
                        try {
                            await api.startAllWebsites();
                            // Update all website statuses
                            const { websites, websiteStatuses } = get();
                            const updatedStatuses = {};
                            websites.forEach(website => {
                                updatedStatuses[website.name] = {
                                    ...websiteStatuses[website.name],
                                    status: 'processing'
                                };
                            });
                            set({ websiteStatuses: updatedStatuses });
                        } catch (error) {
                            set({ error: error.message });
                        }
                    },

                    setActiveTab: (get, set, tab) => {
                        set({ activeTab: tab });
                    },

                    toggleMobileMenu: (get, set) => {
                        set({ showMobileMenu: !get().showMobileMenu });
                    },

                    closeMobileMenu: (get, set) => {
                        set({ showMobileMenu: false });
                    }
                }
            );

            return (selector) => {
                const [state, setState] = useState(store.getState());

                useEffect(() => {
                    return store.subscribe(setState);
                }, []);

                return selector ? selector(state) : [state, store];
            };
        })();

        // Custom hook for periodic updates
        const useInterval = (callback, delay) => {
            const savedCallback = useRef();

            useEffect(() => {
                savedCallback.current = callback;
            }, [callback]);

            useEffect(() => {
                const tick = () => savedCallback.current();
                if (delay !== null) {
                    const id = setInterval(tick, delay);
                    return () => clearInterval(id);
                }
            }, [delay]);
        };

        // Components
        const LoginForm = () => {
            const [state, store] = useStore();
            const [credentials, setCredentials] = useState({ username: '', password: '' });

            const handleSubmit = async (e) => {
                e.preventDefault();
                const success = await store.login(credentials.username, credentials.password);
                if (!success) {
                    setCredentials({ ...credentials, password: '' });
                }
            };

            return (
                <div className="login-container">
                    <div className="text-center mb-4">
                        <h2 className="text-primary">
                            <i className="bi bi-robot me-2"></i>
                            Recipe Automation SaaS
                        </h2>
                        <p className="text-muted">Sign in to manage your WordPress automation</p>
                    </div>

                    <form onSubmit={handleSubmit}>
                        {state.error && (
                            <div className="alert alert-danger" role="alert">
                                <i className="bi bi-exclamation-triangle me-2"></i>
                                {state.error}
                            </div>
                        )}

                        <div className="mb-3">
                            <label className="form-label">Username</label>
                            <input
                                type="text"
                                className="form-control"
                                value={credentials.username}
                                onChange={(e) => setCredentials(prev => ({ ...prev, username: e.target.value }))}
                                required
                                disabled={state.loading}
                            />
                        </div>

                        <div className="mb-4">
                            <label className="form-label">Password</label>
                            <input
                                type="password"
                                className="form-control"
                                value={credentials.password}
                                onChange={(e) => setCredentials(prev => ({ ...prev, password: e.target.value }))}
                                required
                                disabled={state.loading}
                            />
                        </div>

                        <button
                            type="submit"
                            className="btn btn-primary-custom w-100"
                            disabled={state.loading}
                        >
                            {state.loading ? (
                                <>
                                    <span className="loading-spinner me-2"></span>
                                    Signing in...
                                </>
                            ) : (
                                <>
                                    <i className="bi bi-box-arrow-in-right me-2"></i>
                                    Sign In
                                </>
                            )}
                        </button>
                    </form>
                </div>
            );
        };

        const Sidebar = () => {
            const [state, store] = useStore();

            const menuItems = [
                { id: 'dashboard', icon: 'speedometer2', label: 'Dashboard' },
                { id: 'progress', icon: 'bar-chart', label: 'Progress Details' },
                { id: 'analytics', icon: 'graph-up', label: 'Analytics' }
            ];

            return (
                <>
                    <div className={`overlay ${state.showMobileMenu ? 'show' : ''}`} onClick={store.closeMobileMenu}></div>
                    <div className={`sidebar ${state.showMobileMenu ? 'show' : ''}`}>
                        <div className="p-4">
                            <h4 className="text-white mb-4">
                                <i className="bi bi-robot me-2"></i>
                                Recipe Automation
                            </h4>
                            <nav className="nav flex-column">
                                {menuItems.map(item => (
                                    <button
                                        key={item.id}
                                        className={`nav-link ${state.activeTab === item.id ? 'active' : ''}`}
                                        onClick={() => {
                                            store.setActiveTab(item.id);
                                            store.closeMobileMenu();
                                        }}
                                    >
                                        <i className={`bi bi-${item.icon} me-2`}></i>
                                        {item.label}
                                    </button>
                                ))}
                                <button
                                    className="nav-link mt-auto"
                                    onClick={store.logout}
                                >
                                    <i className="bi bi-box-arrow-right me-2"></i>
                                    Logout
                                </button>
                            </nav>
                        </div>
                    </div>
                </>
            );
        };

        const StatsGrid = () => {
            const [state] = useStore();
            const { websites, websiteStatuses } = state;

            const stats = {
                totalWebsites: websites.length,
                processing: Object.values(websiteStatuses).filter(s => s.status === 'processing').length,
                completed: Object.values(websiteStatuses).filter(s => s.status === 'completed').length,
                totalKeywords: Object.values(websiteStatuses).reduce((sum, s) => sum + (s.totalKeywords || 0), 0),
                completedKeywords: Object.values(websiteStatuses).reduce((sum, s) => sum + (s.completedKeywords || 0), 0)
            };

            return (
                <div className="stats-grid">
                    <div className="stat-card">
                        <h3>{stats.totalWebsites}</h3>
                        <p>Total Websites</p>
                    </div>
                    <div className="stat-card">
                        <h3>{stats.processing}</h3>
                        <p>Currently Processing</p>
                    </div>
                    <div className="stat-card">
                        <h3>{stats.completed}</h3>
                        <p>Completed</p>
                    </div>
                    <div className="stat-card">
                        <h3>{stats.completedKeywords}/{stats.totalKeywords}</h3>
                        <p>Keywords Processed</p>
                    </div>
                </div>
            );
        };

        const WebsiteCard = ({ website }) => {
            const [state, store] = useStore();
            const status = state.websiteStatuses[website.name] || {};

            // Debug logging
            useEffect(() => {
                if (status.status === 'processing') {
                    console.log(`[${new Date().toLocaleTimeString()}] ${website.name} - Step: ${status.currentStep}, Keyword: ${status.currentKeyword}`);
                }
            }, [status.currentStep, status.currentKeyword]);

            const getProgressPercentage = () => {
                if (!status.totalKeywords || status.totalKeywords === 0) return 0;
                // Ensure we never exceed 100%
                const rawPercentage = (status.completedKeywords / status.totalKeywords) * 100;
                return Math.min(100, Math.max(0, Math.round(rawPercentage)));
            };

            const progressPercentage = getProgressPercentage();
            const progressStyle = {
                background: `conic-gradient(var(--primary) ${progressPercentage * 3.6}deg, #e5e7eb ${progressPercentage * 3.6}deg)`
            };

            // Ensure completed keywords never exceed total
            const displayedCompleted = Math.min(status.completedKeywords || 0, status.totalKeywords || 0);

            return (
                <div className={`website-card ${status.status || 'idle'}`}>
                    <div className="card-body">
                        <div className="row align-items-center">
                            <div className="col-md-3">
                                <h5 className="card-title mb-1">{website.name}</h5>
                                <p className="text-muted small mb-0">{website.url}</p>
                            </div>
                            
                            <div className="col-md-2">
                                <span className={`status-badge status-${status.status || 'idle'}`}>
                                    {status.status || 'idle'}
                                </span>
                            </div>
                            
                            <div className="col-md-3">
                                <div className="progress-circle" style={progressStyle}>
                                    <span>{progressPercentage}%</span>
                                </div>
                            </div>
                            
                            <div className="col-md-2">
                                <div className="text-center">
                                    <div className="fw-bold">{displayedCompleted}</div>
                                    <div className="text-muted small">of {status.totalKeywords || 0}</div>
                                    <div className="text-muted small">keywords</div>
                                </div>
                            </div>
                            
                            <div className="col-md-2">
                                <div className="btn-group-vertical w-100">
                                    {status.status === 'processing' ? (
                                        <button
                                            className="btn btn-outline-warning btn-sm"
                                            onClick={() => store.stopWebsite(website.name)}
                                        >
                                            <i className="bi bi-stop-fill me-1"></i>
                                            Stop
                                        </button>
                                    ) : (
                                        <button
                                            className="btn btn-outline-primary btn-sm"
                                            onClick={() => store.startWebsite(website.name)}
                                        >
                                            <i className="bi bi-play-fill me-1"></i>
                                            Start
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                        
                        {(status.currentKeyword || status.currentStep) && (
                            <div className="progress-details">
                                <div className="row">
                                    <div className="col-md-6">
                                        <small className="text-muted">Current Keyword:</small>
                                        <div className="fw-bold">{status.currentKeyword || 'Initializing...'}</div>
                                    </div>
                                    <div className="col-md-6">
                                        <small className="text-muted">Current Step:</small>
                                        <div className="fw-bold">{status.currentStep || 'Starting...'}</div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const Dashboard = () => {
            const [state, store] = useStore();

            useEffect(() => {
                store.loadWebsites();
            }, []);

            useInterval(() => {
                if (state.websites.length > 0) {
                    store.loadProgress();
                }
            }, 3000); // Update every 3 seconds

            // Add a force refresh when starting a website
            const handleStartWebsite = async (websiteName) => {
                await store.startWebsite(websiteName);
                // Force immediate progress update
                setTimeout(() => store.loadProgress(), 500);
            };
            if (state.loading) {
                return (
                    <div className="d-flex justify-content-center align-items-center" style={{ height: '50vh' }}>
                        <div className="text-center">
                            <div className="loading-spinner mb-3" style={{ width: '3rem', height: '3rem' }}></div>
                            <p>Loading dashboard...</p>
                        </div>
                    </div>
                );
            }

            return (
                <>
                    <div className="d-flex justify-content-between align-items-center mb-4">
                        <h2>
                            <i className="bi bi-house-door me-2"></i>
                            Dashboard
                        </h2>
                        <button
                            className="btn btn-primary-custom"
                            onClick={async () => {
                                // First reset all states
                                await store.startAllWebsites();
                                // Then force a progress update
                                setTimeout(() => store.loadProgress(), 500);
                            }}
                        >
                            <i className="bi bi-arrow-clockwise me-2"></i>
                            Reset All Progress
                        </button>
                    </div>

                    <StatsGrid />

                    <div className="card">
                        <div className="card-header">
                            <h5 className="mb-0">
                                <i className="bi bi-globe me-2"></i>
                                WordPress Websites
                            </h5>
                        </div>
                        <div className="card-body">
                            {state.websites.length === 0 ? (
                                <div className="text-center py-5">
                                    <i className="bi bi-inbox display-4 text-muted"></i>
                                    <p className="mt-3 text-muted">No websites configured</p>
                                </div>
                            ) : (
                                state.websites.map(website => (
                                    <WebsiteCard key={website.name} website={website} />
                                ))
                            )}
                        </div>
                    </div>
                </>
            );
        };

        const ProgressDetails = () => {
            const [state] = useStore();

            return (
                <>
                    <h2 className="mb-4">
                        <i className="bi bi-bar-chart me-2"></i>
                        Detailed Progress
                    </h2>
                    
                    {Object.entries(state.websiteStatuses).map(([websiteName, status]) => (
                        <div key={websiteName} className="card mb-4">
                            <div className="card-header">
                                <h5 className="mb-0">{websiteName}</h5>
                            </div>
                            <div className="card-body">
                                {status.keywords && status.keywords.length > 0 ? (
                                    status.keywords.map((keyword, index) => (
                                        <div key={index} className="keyword-item">
                                            <div className="flex-grow-1">
                                                <span className="fw-bold">{keyword.keyword || keyword}</span>
                                                {keyword.current_step && (
                                                    <small className="text-muted d-block">
                                                        {keyword.current_step}
                                                    </small>
                                                )}
                                            </div>
                                            <span className={`status-badge status-${keyword.status || 'pending'}`}>
                                                {keyword.status || 'pending'}
                                            </span>
                                        </div>
                                    ))
                                ) : (
                                    <div className="text-center py-4">
                                        <i className="bi bi-info-circle display-6 text-muted"></i>
                                        <p className="mt-2 text-muted">No detailed progress data available</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    ))}
                </>
            );
        };

        const Analytics = () => {
            return (
                <>
                    <h2 className="mb-4">
                        <i className="bi bi-graph-up me-2"></i>
                        Analytics
                    </h2>
                    
                    <div className="card">
                        <div className="card-body text-center py-5">
                            <i className="bi bi-bar-chart display-4 text-muted"></i>
                            <h5 className="mt-3">Analytics Coming Soon</h5>
                            <p className="text-muted">
                                Detailed analytics and reporting features will be available in the next version.
                            </p>
                        </div>
                    </div>
                </>
            );
        };

        const MainApp = () => {
            const [state, store] = useStore();

            useEffect(() => {
                store.checkAuth();
            }, []);

            if (!state.isAuthenticated) {
                return <LoginForm />;
            }

            const renderContent = () => {
                switch (state.activeTab) {
                    case 'progress':
                        return <ProgressDetails />;
                    case 'analytics':
                        return <Analytics />;
                    default:
                        return <Dashboard />;
                }
            };

            return (
                <div className="app-container">
                    <button 
                        className="mobile-menu"
                        onClick={store.toggleMobileMenu}
                    >
                        <i className="bi bi-list"></i>
                    </button>
                    
                    <div className="row g-0">
                        <div className="col-md-3">
                            <Sidebar />
                        </div>
                        <div className="col-md-9 main-content">
                            {renderContent()}
                        </div>
                    </div>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<MainApp />, document.getElementById('root'));
    </script>
</body>
</html>